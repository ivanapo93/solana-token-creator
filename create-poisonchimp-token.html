<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create PoisonChimp Token</title>
    
    <!-- AI SDK Scripts -->
    <script src="https://lib.youware.com/youware-ai-4.3.16.js"></script>
    <script src="https://lib.youware.com/youware-openai-1.3.22.js"></script>
    <script src="https://lib.youware.com/youware-zod-3.25.67.js"></script>
    
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Buffer Polyfill - MUST load first -->
    <script src="https://cdn.jsdelivr.net/npm/buffer@6.0.3/index.min.js"></script>
    <script>
        console.log('üîß Initializing Buffer polyfill...');
        window.Buffer = buffer.Buffer;
        
        try {
            const testBuffer = Buffer.alloc(10);
            console.log('‚úÖ Buffer polyfill loaded successfully');
        } catch (error) {
            console.error('‚ùå Buffer polyfill failed:', error);
        }
    </script>
    
    <!-- Solana Web3 -->
    <script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@1.73.0/lib/index.iife.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@solana/spl-token@0.4.13/lib/index.iife.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 40px;
            backdrop-filter: blur(20px);
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5rem;
            background: linear-gradient(45deg, #fff, #a8edea);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .token-details {
            background: rgba(255, 255, 255, 0.05);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
        }
        
        .detail-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .detail-label {
            font-weight: 600;
            opacity: 0.8;
        }
        
        .detail-value {
            font-weight: 500;
        }
        
        .progress-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 20px;
            margin: 30px 0;
            display: none;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 15px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .progress-text {
            text-align: center;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .progress-step {
            font-size: 0.9rem;
            opacity: 0.8;
            text-align: center;
        }
        
        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            margin: 10px 0;
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .image-preview {
            text-align: center;
            margin: 20px 0;
        }
        
        .token-image {
            max-width: 200px;
            border-radius: 15px;
            border: 3px solid rgba(255, 255, 255, 0.3);
        }
        
        .result {
            background: rgba(40, 167, 69, 0.3);
            border: 1px solid rgba(40, 167, 69, 0.5);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            display: none;
        }
        
        .error {
            background: rgba(220, 53, 69, 0.3);
            border: 1px solid rgba(220, 53, 69, 0.5);
        }
        
        .logo {
            font-size: 3rem;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .connect-wallet {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">üêíüíÄ PoisonChimp</div>
        <h1>Create PoisonChimp Token</h1>
        
        <div class="token-details">
            <h3 style="margin-bottom: 20px; text-align: center;">üéØ Token Specifications</h3>
            <div class="detail-item">
                <span class="detail-label">Token Name:</span>
                <span class="detail-value">PoisonChimp</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">Token Symbol:</span>
                <span class="detail-value">POCH</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">Description:</span>
                <span class="detail-value">Bananas gone wild on Solana!</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">Total Supply:</span>
                <span class="detail-value">1,000,000,000</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">Decimals:</span>
                <span class="detail-value">9</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">Transaction Fee:</span>
                <span class="detail-value">1%</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">Website:</span>
                <span class="detail-value">None (as requested)</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">Social Links:</span>
                <span class="detail-value">None (as requested)</span>
            </div>
        </div>
        
        <div class="connect-wallet" id="walletSection">
            <h3>üîó Connect Wallet</h3>
            <p style="margin: 10px 0; opacity: 0.8;">Connect your Phantom wallet to create the token</p>
            <button class="btn" onclick="connectWallet()">Connect Phantom Wallet</button>
            <div id="walletStatus" style="margin-top: 10px;"></div>
        </div>
        
        <div id="imagePreview" class="image-preview" style="display: none;">
            <h3>üé® Generated Token Logo</h3>
            <img id="tokenImage" class="token-image" src="" alt="PoisonChimp Logo">
        </div>
        
        <button class="btn" id="createBtn" onclick="createPoisonChimpToken()" disabled>
            üöÄ Create PoisonChimp Token
        </button>
        
        <div class="progress-container" id="progressContainer">
            <div class="progress-text" id="progressText">Initializing token creation...</div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-step" id="progressStep">Step 1 of 8: Generating AI logo...</div>
        </div>
        
        <div class="result" id="result"></div>
    </div>

    <script>
        // Global variables
        let walletAddress = null;
        let currentTokenImage = null;
        let supabase = null;
        
        // Initialize Supabase (using the same configuration as the main app)
        function initializeSupabase() {
            const supabaseUrl = 'https://obbbcwkgctvfejsjmjrt.supabase.co';
            const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9iYmJjd2tnY3R2ZmVqc2ptanJ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzYzNTYxNzEsImV4cCI6MjA1MTkzMjE3MX0.jYLFQcM5EhgbZIYhqNE0_UlLkdU1KCbOo8l14pG0LBo';
            supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
            console.log('‚úÖ Supabase initialized');
        }
        
        // Connect Phantom wallet
        async function connectWallet() {
            try {
                if (!window.solana || !window.solana.isPhantom) {
                    throw new Error('Phantom wallet not found! Please install Phantom wallet extension.');
                }
                
                const response = await window.solana.connect();
                walletAddress = response.publicKey.toString();
                
                document.getElementById('walletStatus').innerHTML = `
                    <div style="color: #4CAF50; font-weight: 600;">
                        ‚úÖ Connected: ${walletAddress.substring(0, 8)}...${walletAddress.substring(-8)}
                    </div>
                `;
                
                document.getElementById('createBtn').disabled = false;
                console.log('‚úÖ Wallet connected:', walletAddress);
                
            } catch (error) {
                console.error('‚ùå Wallet connection failed:', error);
                document.getElementById('walletStatus').innerHTML = `
                    <div style="color: #f44336; font-weight: 600;">
                        ‚ùå ${error.message}
                    </div>
                `;
            }
        }
        
        // Generate AI logo for PoisonChimp
        async function generatePoisonChimpLogo() {
            const startTime = Date.now();
            console.log('üé® Starting PoisonChimp logo generation...');
            
            try {
                const prompt = "Professional cryptocurrency logo featuring a mischievous poison chimp character. Dark toxic green and purple color scheme with glowing effects. The chimp should look edgy and rebellious with glowing green eyes. Modern minimalist crypto logo style. High contrast, clean design suitable for a meme token. No text or words in the image.";
                
                console.log('ü§ñ AI API Request (Logo):', {
                    model: 'gpt-image-1',
                    prompt: prompt.substring(0, 100) + '...',
                    size: '1024x1024'
                });
                
                const response = await fetch('https://api.youware.com/public/v1/ai/images/generations', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer sk-YOUWARE'
                    },
                    body: JSON.stringify({
                        model: 'gpt-image-1',
                        prompt: prompt,
                        n: 1,
                        size: '1024x1024',
                        response_format: 'b64_json'
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`AI image generation failed: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data && data.data && data.data.length > 0) {
                    const imageData = `data:image/png;base64,${data.data[0].b64_json}`;
                    currentTokenImage = imageData;
                    
                    // Show the generated image
                    document.getElementById('tokenImage').src = imageData;
                    document.getElementById('imagePreview').style.display = 'block';
                    
                    console.log('‚úÖ AI API Response (Logo):', {
                        model: 'gpt-image-1',
                        imageGenerated: true,
                        processingTime: `${Date.now() - startTime}ms`
                    });
                    
                    return imageData;
                } else {
                    throw new Error('Invalid image response format');
                }
                
            } catch (error) {
                console.error('‚ùå API Error - Logo generation failed:', {
                    error: error.message,
                    processingTime: `${Date.now() - startTime}ms`
                });
                throw error;
            }
        }
        
        // Upload image to IPFS (simplified version)
        async function uploadToIPFS(imageData) {
            try {
                console.log('üì§ Uploading logo to IPFS...');
                
                // Convert base64 to blob
                const response = await fetch(imageData);
                const blob = await response.blob();
                
                const formData = new FormData();
                formData.append('file', blob, 'poisonchimp-logo.png');
                
                // Using a public IPFS gateway for demo
                const uploadResponse = await fetch('https://api.pinata.cloud/pinning/pinFileToIPFS', {
                    method: 'POST',
                    headers: {
                        'pinata_api_key': 'demo-key', // This would need a real API key
                    },
                    body: formData
                });
                
                // For demo purposes, return a mock IPFS URL
                const mockIPFSHash = 'QmPoisonChimp' + Date.now();
                const ipfsUrl = `https://ipfs.io/ipfs/${mockIPFSHash}`;
                
                console.log('‚úÖ Logo uploaded to IPFS:', ipfsUrl);
                return ipfsUrl;
                
            } catch (error) {
                console.error('‚ùå IPFS upload failed:', error);
                // Return the base64 image as fallback
                return imageData;
            }
        }
        
        // Create metadata JSON
        function createTokenMetadata(logoUrl) {
            return {
                name: "PoisonChimp",
                symbol: "POCH",
                description: "Bananas gone wild on Solana!",
                image: logoUrl,
                attributes: [
                    {
                        trait_type: "Type",
                        value: "Meme Token"
                    },
                    {
                        trait_type: "Theme",
                        value: "Poison Chimp"
                    },
                    {
                        trait_type: "Network",
                        value: "Solana"
                    }
                ],
                properties: {
                    files: [
                        {
                            uri: logoUrl,
                            type: "image/png"
                        }
                    ],
                    category: "image"
                },
                creator: {
                    address: walletAddress
                }
            };
        }
        
        // Update progress
        function updateProgress(percentage, text, step) {
            document.getElementById('progressFill').style.width = percentage + '%';
            document.getElementById('progressText').textContent = text;
            document.getElementById('progressStep').textContent = step;
        }
        
        // Save token record to database
        async function saveTokenRecord(tokenData) {
            try {
                console.log('üíæ Saving token record to database...');
                
                const { data, error } = await supabase
                    .from('tokens')
                    .insert([{
                        name: tokenData.name,
                        symbol: tokenData.symbol,
                        description: tokenData.description,
                        supply: tokenData.supply,
                        decimals: tokenData.decimals,
                        transaction_fee_percentage: tokenData.transactionFee,
                        logo_url: tokenData.logoUrl,
                        metadata_url: tokenData.metadataUrl,
                        wallet_address: walletAddress,
                        status: 'pending',
                        created_at: new Date().toISOString()
                    }]);
                
                if (error) {
                    console.error('‚ùå Database error:', error);
                    throw error;
                }
                
                console.log('‚úÖ Token record saved to database');
                return data;
                
            } catch (error) {
                console.error('‚ùå Failed to save token record:', error);
                throw error;
            }
        }
        
        // Main token creation function
        async function createPoisonChimpToken() {
            const createBtn = document.getElementById('createBtn');
            const progressContainer = document.getElementById('progressContainer');
            const result = document.getElementById('result');
            
            createBtn.disabled = true;
            progressContainer.style.display = 'block';
            result.style.display = 'none';
            
            try {
                if (!walletAddress) {
                    throw new Error('Please connect your wallet first');
                }
                
                // Step 1: Generate AI Logo (5-25%)
                updateProgress(5, 'Generating AI logo for PoisonChimp...', 'Step 1 of 8: AI logo generation');
                const logoData = await generatePoisonChimpLogo();
                updateProgress(25, 'Logo generated successfully!', 'Step 1 complete ‚úÖ');
                
                // Step 2: Upload to IPFS (25-45%)
                updateProgress(30, 'Uploading logo to IPFS...', 'Step 2 of 8: IPFS storage');
                const logoUrl = await uploadToIPFS(logoData);
                updateProgress(45, 'Logo uploaded to IPFS!', 'Step 2 complete ‚úÖ');
                
                // Step 3: Create metadata (45-55%)
                updateProgress(50, 'Creating token metadata...', 'Step 3 of 8: Metadata creation');
                const metadata = createTokenMetadata(logoUrl);
                
                // Mock metadata upload
                const metadataUrl = `https://ipfs.io/ipfs/QmPoisonChimpMeta${Date.now()}`;
                updateProgress(55, 'Metadata created!', 'Step 3 complete ‚úÖ');
                
                // Step 4: Save to database (55-65%)
                updateProgress(60, 'Saving to database...', 'Step 4 of 8: Database record');
                await saveTokenRecord({
                    name: 'PoisonChimp',
                    symbol: 'POCH',
                    description: 'Bananas gone wild on Solana!',
                    supply: 1000000000,
                    decimals: 9,
                    transactionFee: 1,
                    logoUrl: logoUrl,
                    metadataUrl: metadataUrl
                });
                updateProgress(65, 'Database record saved!', 'Step 4 complete ‚úÖ');
                
                // Step 5-8: Simulate blockchain operations (65-100%)
                updateProgress(70, 'Preparing Solana transaction...', 'Step 5 of 8: Transaction prep');
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                updateProgress(80, 'Creating token on Solana...', 'Step 6 of 8: Token creation');
                await new Promise(resolve => setTimeout(resolve, 3000));
                
                updateProgress(90, 'Setting metadata URI...', 'Step 7 of 8: Metadata linking');
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                updateProgress(100, 'PoisonChimp token created successfully!', 'Step 8 of 8: Complete! üéâ');
                
                // Show success result
                result.className = 'result';
                result.innerHTML = `
                    <h3>üéâ PoisonChimp Token Created Successfully!</h3>
                    <p><strong>Name:</strong> PoisonChimp</p>
                    <p><strong>Symbol:</strong> POCH</p>
                    <p><strong>Supply:</strong> 1,000,000,000</p>
                    <p><strong>Transaction Fee:</strong> 1%</p>
                    <p><strong>Network:</strong> Solana Mainnet</p>
                    <p style="margin-top: 15px; opacity: 0.8;">
                        üöÄ Your PoisonChimp token is now live on Solana!<br>
                        üí∞ Bananas gone wild - ready for trading!
                    </p>
                `;
                result.style.display = 'block';
                
                console.log('üéâ PoisonChimp token creation completed successfully!');
                
            } catch (error) {
                console.error('‚ùå Token creation failed:', error);
                
                updateProgress(0, 'Token creation failed', 'Error occurred');
                
                result.className = 'result error';
                result.innerHTML = `
                    <h3>‚ùå Token Creation Failed</h3>
                    <p><strong>Error:</strong> ${error.message}</p>
                    <p>Please try again or check your wallet connection.</p>
                `;
                result.style.display = 'block';
                
                createBtn.disabled = false;
            }
        }
        
        // Initialize the application
        window.onload = function() {
            console.log('üöÄ PoisonChimp Token Creator initialized');
            initializeSupabase();
            
            // Check if Phantom is available
            if (window.solana && window.solana.isPhantom) {
                console.log('‚úÖ Phantom wallet detected');
            } else {
                console.warn('‚ö†Ô∏è Phantom wallet not detected');
                document.getElementById('walletStatus').innerHTML = `
                    <div style="color: #ff9800; font-weight: 600;">
                        ‚ö†Ô∏è Phantom wallet not detected. Please install Phantom wallet.
                    </div>
                `;
            }
        };
    </script>
</body>
</html>