<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@solana/spl-token v0.4.x+ Modern API Test</title>
    <style>
        body { 
            font-family: 'Courier New', monospace; 
            background: #1a1a1a; 
            color: #00ff00; 
            padding: 20px; 
            line-height: 1.6;
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background: #000; 
            padding: 20px; 
            border: 2px solid #00ff00; 
            border-radius: 10px;
        }
        .header { 
            text-align: center; 
            border-bottom: 2px solid #00ff00; 
            padding-bottom: 20px; 
            margin-bottom: 20px; 
        }
        .test-section { 
            margin: 20px 0; 
            padding: 15px; 
            border: 1px solid #333; 
            border-radius: 5px; 
            background: #111;
        }
        .button { 
            background: #00ff00; 
            color: #000; 
            padding: 10px 20px; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            font-weight: bold; 
            margin: 10px 5px;
        }
        .button:hover { 
            background: #00cc00; 
        }
        .success { color: #00ff00; }
        .error { color: #ff4444; }
        .warning { color: #ffaa00; }
        .info { color: #4488ff; }
        pre { 
            background: #222; 
            padding: 10px; 
            border-radius: 5px; 
            overflow-x: auto; 
            border-left: 4px solid #00ff00;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-pass { background: #00ff00; }
        .status-fail { background: #ff4444; }
        .status-pending { background: #ffaa00; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß™ @solana/spl-token v0.4.x+ Modern API Test</h1>
            <p>Testing latest SPL Token library installation and modern API functions</p>
        </div>

        <div class="test-section">
            <h2>üìã Installation Status</h2>
            <div id="installation-status">
                <p><span class="status-indicator status-pending"></span>Checking installation...</p>
            </div>
            <button class="button" onclick="runInstallationTest()">üîÑ Refresh Installation Test</button>
        </div>

        <div class="test-section">
            <h2>üîß Modern API Functions</h2>
            <div id="api-functions-status">
                <p>Checking modern SPL Token functions...</p>
            </div>
        </div>

        <div class="test-section">
            <h2>üåê Network Connection</h2>
            <div id="network-status">
                <p>Testing Solana network connection...</p>
            </div>
            <button class="button" onclick="testNetworkConnection()">üîó Test Connection</button>
        </div>

        <div class="test-section">
            <h2>üèóÔ∏è Mock Token Creation Test</h2>
            <div id="token-creation-status">
                <p>Ready to test modern createMint API...</p>
            </div>
            <button class="button" onclick="runMockTokenTest()">ü™ô Test Modern API</button>
        </div>

        <div class="test-section">
            <h2>üìä Detailed Results</h2>
            <div id="detailed-results">
                <pre id="console-output">Test results will appear here...</pre>
            </div>
            <button class="button" onclick="clearResults()">üßπ Clear Results</button>
        </div>
    </div>

    <!-- Load Solana Libraries -->
    <script>
        // Custom console logging to capture output
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        
        let consoleOutput = '';
        
        function captureLog(...args) {
            const message = args.join(' ');
            consoleOutput += message + '\n';
            document.getElementById('console-output').textContent = consoleOutput;
            originalLog(...args);
        }
        
        function captureError(...args) {
            const message = args.join(' ');
            consoleOutput += '[ERROR] ' + message + '\n';
            document.getElementById('console-output').textContent = consoleOutput;
            originalError(...args);
        }
        
        function captureWarn(...args) {
            const message = args.join(' ');
            consoleOutput += '[WARN] ' + message + '\n';
            document.getElementById('console-output').textContent = consoleOutput;
            originalWarn(...args);
        }
        
        console.log = captureLog;
        console.error = captureError;
        console.warn = captureWarn;
    </script>

    <!-- Load dependencies in sequence -->
    <script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@1.95.4/lib/index.iife.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@solana/spl-token@0.4.9/lib/index.iife.min.js"></script>
    
    <script>
        // Wait for libraries to load and properly expose functions
        setTimeout(() => {
            if (typeof solanaWeb3 !== 'undefined' && typeof splToken !== 'undefined') {
                console.log('üì¶ Loading @solana/spl-token v0.4.9 functions...');
                console.log('Available splToken methods:', Object.keys(splToken));
                
                // Setup global functions from SPL Token v0.4.9
                window.createMint = splToken.createMint;
                window.getMint = splToken.getMint;
                window.getOrCreateAssociatedTokenAccount = splToken.getOrCreateAssociatedTokenAccount;
                window.mintTo = splToken.mintTo;
                window.transfer = splToken.transfer;
                window.getAssociatedTokenAddress = splToken.getAssociatedTokenAddress;
                window.TOKEN_PROGRAM_ID = splToken.TOKEN_PROGRAM_ID;
                window.ASSOCIATED_TOKEN_PROGRAM_ID = splToken.ASSOCIATED_TOKEN_PROGRAM_ID;
                window.MINT_SIZE = splToken.MINT_SIZE;
                
                // Debug: Log what we actually got
                console.log('createMint type:', typeof window.createMint);
                console.log('TOKEN_PROGRAM_ID:', window.TOKEN_PROGRAM_ID?.toString());
                
                // Auto-run initial tests
                runInstallationTest();
            } else {
                console.error('Libraries failed to load:');
                console.error('solanaWeb3:', typeof solanaWeb3);
                console.error('splToken:', typeof splToken);
                updateStatus('installation-status', '‚ùå Failed to load Solana libraries', false);
            }
        }, 3000);

        function updateStatus(elementId, message, success = null) {
            const element = document.getElementById(elementId);
            let statusClass = 'status-pending';
            if (success === true) statusClass = 'status-pass';
            if (success === false) statusClass = 'status-fail';
            
            element.innerHTML = `<p><span class="status-indicator ${statusClass}"></span>${message}</p>`;
        }

        function runInstallationTest() {
            console.log('üöÄ Testing @solana/spl-token v0.4.x+ Installation');
            
            // Check basic library loading
            if (typeof solanaWeb3 === 'undefined') {
                updateStatus('installation-status', '‚ùå @solana/web3.js not loaded', false);
                return;
            }
            
            if (typeof splToken === 'undefined') {
                updateStatus('installation-status', '‚ùå @solana/spl-token not loaded', false);
                return;
            }
            
            updateStatus('installation-status', '‚úÖ Libraries loaded successfully', true);
            
            // Test modern API functions
            testModernApiFunctions();
        }

        function testModernApiFunctions() {
            console.log('üì¶ Testing Modern API Functions');
            
            const requiredFunctions = [
                'createMint',
                'getMint', 
                'getOrCreateAssociatedTokenAccount',
                'mintTo',
                'transfer',
                'getAssociatedTokenAddress'
            ];
            
            const requiredConstants = [
                'TOKEN_PROGRAM_ID',
                'ASSOCIATED_TOKEN_PROGRAM_ID',
                'MINT_SIZE'
            ];
            
            let allAvailable = true;
            let statusHtml = '';
            
            // Test functions
            requiredFunctions.forEach(funcName => {
                const available = typeof window[funcName] === 'function';
                const icon = available ? '‚úÖ' : '‚ùå';
                statusHtml += `<p><span class="status-indicator ${available ? 'status-pass' : 'status-fail'}"></span>${icon} ${funcName}</p>`;
                if (!available) allAvailable = false;
                console.log(`${icon} ${funcName}: ${available ? 'Available' : 'Missing'}`);
            });
            
            // Test constants
            requiredConstants.forEach(constName => {
                const available = typeof window[constName] !== 'undefined';
                const icon = available ? '‚úÖ' : '‚ùå';
                statusHtml += `<p><span class="status-indicator ${available ? 'status-pass' : 'status-fail'}"></span>${icon} ${constName}</p>`;
                if (!available) allAvailable = false;
                console.log(`${icon} ${constName}: ${available ? 'Available' : 'Missing'}`);
            });
            
            document.getElementById('api-functions-status').innerHTML = statusHtml;
            
            if (allAvailable) {
                console.log('üéâ All modern SPL Token functions available!');
            } else {
                console.error('‚ùå Some modern functions are missing');
            }
        }

        async function testNetworkConnection() {
            console.log('üåê Testing Solana Network Connection');
            updateStatus('network-status', '‚è≥ Connecting to Solana network...', null);
            
            try {
                const connection = new solanaWeb3.Connection('https://solana-rpc.publicnode.com', 'confirmed');
                const slot = await connection.getSlot();
                
                updateStatus('network-status', `‚úÖ Connected to Solana - Current slot: ${slot}`, true);
                console.log(`‚úÖ Network connection successful - Slot: ${slot}`);
                
                // Store connection for other tests
                window.testConnection = connection;
                
            } catch (error) {
                updateStatus('network-status', `‚ùå Connection failed: ${error.message}`, false);
                console.error(`‚ùå Network connection failed: ${error.message}`);
            }
        }

        async function runMockTokenTest() {
            console.log('üèóÔ∏è Testing Modern Token Creation API');
            updateStatus('token-creation-status', '‚è≥ Testing modern createMint API...', null);
            
            try {
                // Check if modern functions are available
                if (typeof createMint !== 'function') {
                    throw new Error('createMint function not available');
                }
                
                if (!window.testConnection) {
                    throw new Error('Network connection not established - run connection test first');
                }
                
                // Generate test keypairs
                const mintKeypair = solanaWeb3.Keypair.generate();
                const payerKeypair = solanaWeb3.Keypair.generate();
                
                console.log(`üîë Generated test mint address: ${mintKeypair.publicKey.toString()}`);
                console.log(`üí∞ Test payer address: ${payerKeypair.publicKey.toString()}`);
                
                // Test modern API parameters (without actually creating - would need funded wallet)
                const mockParams = {
                    connection: window.testConnection,
                    payer: payerKeypair,
                    mintAuthority: payerKeypair.publicKey,
                    freezeAuthority: payerKeypair.publicKey,
                    decimals: 9,
                    keypair: mintKeypair,
                    confirmOptions: { commitment: 'confirmed' },
                    programId: TOKEN_PROGRAM_ID
                };
                
                console.log('‚úÖ Modern createMint parameters validated');
                console.log('üìã API signature: createMint(connection, payer, mintAuthority, freezeAuthority, decimals, keypair, confirmOptions, programId)');
                console.log('üéØ This is the v0.4.x+ modern API - no manual transaction building required!');
                
                updateStatus('token-creation-status', '‚úÖ Modern API ready for production use', true);
                
            } catch (error) {
                updateStatus('token-creation-status', `‚ùå Test failed: ${error.message}`, false);
                console.error(`‚ùå Mock token test failed: ${error.message}`);
            }
        }

        function clearResults() {
            consoleOutput = '';
            document.getElementById('console-output').textContent = 'Results cleared...';
        }
    </script>
</body>
</html>